<script lang="ts">
  import * as m from "$lib/features/i18n/messages";

  import DropdownItem from "$lib/components/dropdown/DropdownItem.svelte";
  import DropdownList from "$lib/components/dropdown/DropdownList.svelte";
  import ShadowList from "$lib/components/section-list/ShadowList.svelte";
  import type { Season } from "$lib/models/Season";
  import type { MediaSummary } from "$lib/requests/models/MediaSummary";
  import { writable } from "svelte/store";
  import EpisodeItem from "./components/EpisodeItem.svelte";
  import { useSeasonEpisodes } from "./stores/useSeasonEpisodes";
  import { mediaListHeightResolver } from "./utils/mediaListHeightResolver";

  type SeasonListProps = {
    show: MediaSummary;
    seasons: Season[];
  };

  const { show, seasons }: SeasonListProps = $props();

  const active = writable(seasons.at(0));
  const { list } = $derived(useSeasonEpisodes(show.slug, $active.number));

  const title = $derived(m.season_number_label({ number: $active.number }));
</script>

<ShadowList
  id={`season-list-${show.slug}`}
  items={$list}
  {title}
  --height-list={mediaListHeightResolver("episode")}
>
  {#snippet item(episode)}
    <EpisodeItem {episode} {show} />
  {/snippet}
  {#snippet actions()}
    <DropdownList
      label="Seasons"
      style="flat"
      variant="primary"
      color="blue"
      text="capitalize"
      size="small"
    >
      {title}
      {#snippet items()}
        {#each seasons as season}
          <DropdownItem color="blue" onclick={() => active.set(season)}>
            {m.season_number_label({ number: season.number })}
          </DropdownItem>
        {/each}
      {/snippet}
    </DropdownList>
  {/snippet}
</ShadowList>

<style>
  :global(.shadow-list-container) {
    :global(.trakt-dropdown-list-container[data-size="small"]) {
      margin-right: var(--ni-neg-36);
    }
  }
</style>
